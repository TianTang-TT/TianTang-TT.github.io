---
title: js隐式类型转化例子分析
date: 2016-06-29 13:45:57
categories: javascript
tags: [javascript]
keywords: [隐式类型转换, sb, js隐式类型转换, 一段js代码输出sb]
---

### 1.前言

偶然间看到一段很有意思的代码，一段不含任何字母数字，只包含各种括号，加减号的代码执行结果出现了'sb'一个字符串，(eval('(!(~+[])+{})[--[~+""][+[]]*[~+[]]+~~!+[]]+({}+[])[[~!+[]*~+[]]]')结果返回'sb')真是amazing，当时百思不得姐，回过头仔细想想，一段段的分析一下，原理便水落石出了。

<!-- more -->

***

### 2.思路

```javascript
eval('(!(~+[])+{})[--[~+""][+[]]*[~+[]]+~~!+[]]+({}+[])[[~!+[]*~+[]]]')   //'sb'
```

乍一看毫无头绪，这段代码中没有任何英文，也没有数字，那么字符串'sb'是怎么出现的？仔细分析，代码中多次出现了'!','+'，'!'的作用是取反，返回一个布尔值，那么可能会出现'false'或者'true'，那么我们要的'sb'中的's'已经出现，而'+'有一个重要的作用，那就是等同于Number()函数的效果，将值转为number类型，并且有拼接字符串的作用，如果'+'的一边是字符串而另一边不是，那么将会被隐式的转换为字符串类型并进行拼接。到这里，思路应该很清晰了，某些被转换后的值会出现英文字母和数字，然后再结合'[]'那么就可以取到相应的字母了。下面来具体分析原理。


### 3.具体分析
```javascript
(!(~+[])+{})[--[~+""][+[]]*[~+[]]+~~!+[]]+({}+[])[[~!+[]*~+[]]]

//将上面代码进行拆分，可得到如下部分
(!(~+[])+{})  ，[--[~+""][+[]]*[~+[]]+~~!+[]] ， ({}+[]) ， [[~!+[]*~+[]]]
//分别将上述四部分用$1,$2,$3,$4来表示，即求$1和$2的运算结果 + $3和$4的运算结果。
var $1, $2, $3, $4;
	$1 = (!(~+[])+{});
	$2 = [--[~+""][+[]]*[~+[]]+~~!+[]];
	$3 = ({}+[]);
	$4 = [[~!+[]*~+[]]];

//分析$1 = (!(~+[])+{});运算顺序为先计算(~+[]),然后对其取反，再与{}相加
(~+[])           //返回-1， +[]此处的加号相当Number函数，所以+[]返回0，再对其进行按位非操作，即取相反数再减去1
!(~+[])          //返回false
false + {}       //返回'false[object Object]', 一元加操作符会将布尔值和对象通过toString()方法分别
                 //转为'false'和'[object Object]'
//所以$1的运算结果为'false[object Object]'

//分析$2 = [--[~+""][+[]]*[~+[]]+~~!+[]]; 先计算--[~+""][+[]]，然后计算[~+[]]，两相作乘，然后与~~!+[]的结果相加
--[~+""][+[]]          //返回-2，[~+""]返回[-1],[+[]]返回[0]，即为--[-1][0]
                       //由于方括号[]优先级高于--， 所以返回-2
[~+[]]                 //返回[-1]
--[~+""][+[]]*[~+[]]   //返回2，一元乘操作符会将非数字转为数字，[-1]被转为-1,即为(-2)*(-1) 
~~!+[]                 //返回1，~操作符会将布尔值转为number
[2 + 1]
//所以$2的运算结果为[3]

//分析$3 = ({}+[]),一元加操作符会将对象通过toString()分别 转为'[object Object]' 和 ''
({}+[])          //返回'[object Object]'
//所以$3的运算结果为'[object Object]'

//分析$4 = [[~!+[]*~+[]]];先计算~!+[]，后计算~+[]，然后结果相乘
~!+[]           //返回-2
~+[]            //返回-1
[[~!+[]*~+[]]]  //返回[[2]]
//所以$4的运算结果为[[2]]

//因此整个表达式可以简化为
'false[object Object]'[3] + '[object Object]'[[2]]
//返回'sb'
//此处要注意'string'[[2]]这种写法，string后面跟方括号，里面需要一个number类型的数值n来返回'string'
//的第n位上的字符，因此方括号里面的值会被通过Number()方法转为数值类型，[2]被转为2

```

### 4.总结

1.主要考察js中隐式类型转换,一元+和~操作符将值转为number类型的值，相当于Number方法
2.当+操作符两边类型不同时，若有一边为字符串，则将另一边也转为字符串，然后执行拼接。
3.将对象转为基本类型值时，先调用valueOf方法，若还是对象，则调用toString方法。
4.数组的valueOf方法返回其自身。

