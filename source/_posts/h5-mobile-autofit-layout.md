---
title: 移动端适配方案浅析
date: 2017-09-18 14:57:03
categories: [h5, mobile]
tags: [h5, mobile, viewport]
keywords: [h5, mobile, viewport, layoutviewport, visualviewport, dpr, px, ppi, meta, device-width, 视口缩放, 移动端适配方案, flexible, lib-flexible, flexible分析, lib-flexible分析]
---

### 1. 背景
随着移动设备的越来越普及，各种智能手持设备日新月异，为人们带来方便快捷的生活方式和体验，而对于前端开发者来说，不同尺寸，不同平台的兼容性适配性问题却变得越来越麻烦，逐渐变成了一个让人头疼的问题。当然，魔高一尺，道高一丈，优秀的解决方案也不断涌现，如淘宝移动端适配方案`lib-flexible`, 网易适配方案的，真正实现了`write once, run everywhere`, 那么这种做法深层次的原理到底是怎么样的呢？

<!-- more -->

### 2. 开发流程
在前端开发之前，设计会给我们一个psd文件，称之为视觉稿。对移动端开发而言，要做到页面高清，视觉稿会遵循以下的规范：
* 首先会选取一款手机的屏幕宽高作为基准(iPhone6 375x667)
* 对于retina屏幕(如: dpr=2) ，为了达到高清效果，视觉稿的画布大小会是基准的2倍

对于我们开发来说，从设计手中拿到的应该是一份设计稿(一般是750px),以及相应的图片(@1x, @2x, @3x的图片),而我们要做的就是将设计稿还原成html页面，并且保证在不同分辨率的设备上有相同的展示效果。但是在实际的开发过程中，往往会因为屏幕大小，分辨率不同而出现一些问题。对不同屏幕大小的手机来说，如果我们使用了固定布局，如果在小屏幕手机上刚好完美布局，那么再大屏下就可能出现空隙或者留白，同样的，如果我们只考虑大屏幕的设备，那么在小屏幕上就可能会出现布局错位的情况。在某些高清屏幕(retina屏)下，1px的边框往往看起来不像是1px，因为它本可以 '更细'，而且某些图片在高清屏下可能会出现模糊的现象。带着这些问题，我们来一探究竟。

### 3. 基本概念
##### 设备像素(device-pixel)
> 又叫物理像素，显示器(手机屏幕)上最小的物理显示单元，在操作系统的调度下，每一个设备像素都有自己的颜色值和亮度值。
 
##### 设备独立像素(device-independent-pixel)
> 逻辑像素，计算机坐标系统中的一个点，该点代表一个可由程序使用并控制的虚拟像素，然后由相关系统转换为物理像素。这是一个逻辑上存在的单位，在dpr=1的屏幕下，1设备独立像素由1物理像素来渲染，而在dpr=2的高清屏幕下，当1px设备独立像素由4个一组的物理像素来渲染，比较直观的理解是1px css像素由4个物理像素来渲染(此时设备独立像素=css像素=屏宽）
 
##### Css像素
> 是一个相对值。独立于设备的 用于逻辑上衡量像素的单位。可以理解为“直觉”像素，css和js中使用的抽象单位。一般情况下我们认为  css像素==设备独立像素

##### 设备像素比(dpr)
> dpr = 物理像素/设备独立像素(在某一方向上，x方向或者y方向)，是指在移动开发中设备独立像素个css像素占用多少物理像素，如2代表1个css像素用2x2个物理像素像素来渲染。未缩放情况下，即为1css像素由多少物理像素来渲染。在js中，通过window.devicePixelRatio来获取，在css中通过device-pixel-ratio来获取。

下图中一组红绿蓝组成一个物理像素点,图像由许许多多的物理像素点组合渲染出来，最终达到我们页面上看到的效果。
![](http://7xt6mo.com1.z0.glb.clouddn.com/687474703a2f2f6f70656f6b6634756b2e626b742e636c6f7564646e2e636f6d2f312e6a706567.jpg)

在普通屏幕下，1设备独立像素(css像素）由1物理像素渲染，1:1;而在dpr为2的屏幕下，1设备独立像素(css像素)是由4物理像素来渲染，1:4。
![](http://7xt6mo.com1.z0.glb.clouddn.com/retina-web-3.jpg)

从下面的图片中可以很直观的看出渲染效果，高清屏下渲染1css像素由更多的物理像素点来渲染，因此看上去更加的细腻清晰。
![](http://7xt6mo.com1.z0.glb.clouddn.com/68747470733a2f2f7773332e73696e61696d672e636e2f6c617267652f303036744e6337396779316667396474786e396c7a6a333064773035726161722e6a7067.jpg)

根本原理就是渲染同样尺寸的css像素，高清屏用了更多的物理像素点，使得单位面积的像素点数目更多(ppi更高)
![](http://7xt6mo.com1.z0.glb.clouddn.com/3.png)

### 4. 图片高清问题
##### 位图像素
> 一个位图像素是栅格图像(如：png, jpg, gif等),最小的数据单元。每一个位图像素都包含着一些自身的显示信息(如：显示位置，颜色值，透明度等)。

理论上来说，1个位图像素对应于1个物理像素，图片才能得到完美清晰的展示，在一般的屏幕下，我们也确实是这么做的，假设需要显示一个200x300px的图片元素，那我们用一张200x300px的图片便能完美呈现，但是在如果在高清屏下，这么做图片就会显得有点模糊。还是以iphone6为例，又上面的内容我们可以知道，在iphone6下，1个设备独立像素实际上是由4个物理像素点来渲染，那么200x300像素的图实际上就会有400x600个物理像素点来渲染，而我们提供的图片却只有200x300，因此便会出现1个位图像素由4个物理像素点来渲染的情况，而问题是这4个像素点所取的色值跟这1个位图像素的色值是不一样的，遵循的原理是就近取色，色值只能跟这个位图像素的色值相近，而不是相同，因此图片会在高清屏下出现模糊的情况。
![](http://7xt6mo.com1.z0.glb.clouddn.com/4.png)

那么这种情况我们怎么解决呢，答案就是@2x图，也就是2倍图。这也是为什么在一开始说设计师将画布放大，提供@2x图和@3x图(为dpr为3的设备准备)的原因。在iphone6下，我们渲染一个200x300px的图，使用的将是@2x图，也就是400x600px的元素，由于1css像素由4物理像素渲染，那么一个位图像素一一对应一个物理像素，达到1:1的匹配度，高清图得以完美呈现。

但是如果我们在所有的屏幕上都是用@2x图的话，又会出现什么问题呢。前面说到了在dpr为1的屏幕下，1css像素=1物理像素，之间已经是1:1对应的关系了。还举之前的栗子，我们有一个200x300px的图片元素要渲染，提供了@2x的图来渲染这个元素，因为1css像素由1物理像素来渲染，提供的400x600像素的图就会显得有点'多余'，1个物理像素点只能就近的选取1个位图像素来渲染。虽然不会造成模糊，但是看起来图片却是损失了锐利度，而且造成了资源的浪费。
![](http://7xt6mo.com1.z0.glb.clouddn.com/2.png)

如何解决这种问题？前文中提到，我们可以在css和js中都可以获取到dpr，那么我们通过不同的dpr来加载不同的图片。针对不同的dpr，当需要图片的时候，我们可以在图片url上缀上@2x还是@3x图片的信息，比如需要一张图logo.png,它的地址是
`http://www.test.com/img/logo.png`
那么，在dpr不同的设备下，这个url的文件名应该是不同的
```js
// dpr = 1
http://www.test.com/img/logo.png

// dpr = 2
http://www.test.com/img/logo_@2x.png

// dpr = 3
http://www.test.com/img/logo_@3x.png
```
具体到代码中，我们可以借助scss，less等工具来实现，根据不同的dpr加载不同的图片。

### 5. 1px边框问题
图片1像素边框的问题大概是设计师比较关注的问题，那么，什么是1像素边框问题。在retina屏幕下，1px的css像素实际上是由4个物理像素来渲染的，体现在宽高上就是1px宽的border，实际上是由2px的物理像素来渲染的。设计稿上是最细的线1px的边框，在实际的retina屏幕下却是由2物理像素来渲染的，而设计师要的则是最细的1px的物理像素渲染的线。也就是说，实际上我们需要在代码中写0.5px，那这样，这条线就会由1个物理像素的宽度了。但是问题是，除了iOS 8及以上，ios7以下，android等其他系统里，0.5px会被当成为0px处理。
![](http://7xt6mo.com1.z0.glb.clouddn.com/1.png)

如何实现这样的一个0.5px的线呢，一种简单的做法就是元素的scale
```CSS

.scale{
    position: relative;
}
.scale:after{
    content:"";
    position: absolute;
    bottom:0px;
    left:0px;
    right:0px;
    border-bottom:1px solid #ddd;
    -webkit-transform:scaleY(.5);
    -webkit-transform-origin:0 0;
}

```

我们在代码中继续写`border: 1px solid #ddd`,然后通过`transform:scaleY(0.5)`缩小0.5倍来达到0.5px的目的，但是这样的hack不够通用(比如圆角)，写起来也很麻烦。
网上解决方案也很多，这里比较推荐的还是`页面整体scale`方案，对于`dpr=2`的页面，比如iphone6，加入如下的`meta`标签，将页面缩放`1/dpr`以实现0.5px的效果。
```html
<meta name="viewport" content="width=640,initial-scale=0.5,maximum-scale=0.5, minimum-scale=0.5,user-scalable=no">
```
这样可以完美实现1px物理像素的线，但是同时也带来了一些问题：
* 字体大小会被缩放
* 页面布局也会被缩放
这两个问题后面会讲到。

### 6. 多屏适配问题
做PC页面的时候，我们按照设计图的尺寸来就好，这个侧边栏200px，那个按钮50px的。可是，当我们开始做移动端页面的时候，设计师给了一份宽度为750px的设计图。那么，我们把这份设计图实现在各个手机上的过程就是『适配』。
![](http://7xt6mo.com1.z0.glb.clouddn.com/rem-6.jpg)
上图是著名的手淘前端团队的协作模式，而整个手淘设计师和前端开发的适配协作基本思路是：
* 选择一种尺寸作为设计和开发基准
* 定义一套适配规则，自动适配剩下的
* 特殊适配效果给出设计效果
在设计和开发协作过程中，设计师通常会以iphone6为基准设计尺寸，交付给前端的是`750x1334px`的设计图，前端开发人员通过一套适配规则自动适配到其他的尺寸。在研究适配方案以前，我们先普及一下基本的概念。